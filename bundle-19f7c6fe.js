(()=>{"use strict";const t={width:100,height:100},e=[4,8],n=8*t.width,a=3*t.height,s=8*t.width,i=4*t.height,o=document.createElement("template");o.innerHTML=`\n  <style>\n    :host {\n      display: inline-block;\n      user-select: none;\n      margin: 0;\n      padding: 0;\n      border: 0;\n    }\n    *, *::before, *::after {\n      margin: 0;\n      padding: 0;\n      box-sizing: border-box;\n      border: 0;\n      font: inherit;\n      vertical-align: baseline;\n    }\n    svg {\n      display: block;\n      width: ${t.width}px;\n      height: ${t.height}px;\n    }\n    .wrap {\n      display: block;\n      width: fit-content;\n      height: fit-content;\n      cursor: grab;\n    }\n  </style>\n  <div class="wrap" draggable="true"></div>\n`;class r extends HTMLElement{constructor(){super(),this._data=null,this.dataSource=null,this.dragstartCallback=void 0;const t=this.attachShadow({mode:"open"});t.appendChild(o.content.cloneNode(!0)),this._wrap=t.querySelector(".wrap"),this._wrap.addEventListener("dragstart",t=>{var e;this.dragstartCallback&&this.dragstartCallback(),this._data&&(null===(e=t.dataTransfer)||void 0===e||e.setData("text/plain",JSON.stringify({data:this._data,dataSource:this.dataSource})),t.dataTransfer.effectAllowed="move")}),this._wrap.addEventListener("mousemove",t=>{t.stopPropagation()}),this._wrap.addEventListener("mousedown",t=>{t.stopPropagation()})}set data(t){this._data=t,this.dataset.serialized=JSON.stringify(t),this.render()}get data(){return this._data}render(){this._wrap.innerHTML="",this._data&&Array.isArray(this._data.points)&&this._wrap.appendChild((e=>{const n=document.createElementNS("http://www.w3.org/2000/svg","svg");return n.setAttribute("viewBox",`0 0 ${t.width} ${t.height}`),n.appendChild((t=>{const e=document.createElementNS("http://www.w3.org/2000/svg","polygon"),n=t.points.map(t=>t.join(",")).join(" ");return e.setAttribute("points",n),e.setAttribute("fill",t.fill),e.setAttribute("stroke",t.stroke),e.setAttribute("stroke-width","2"),e})(e)),n})(this._data))}}customElements.define("polygon-item",r);class d extends HTMLElement{constructor(){super(...arguments),this._data=[],this.dataSource=null}setDragAndDropHandler(){this.addEventListener("dragover",t=>{t.preventDefault()}),this.addEventListener("drop",t=>{var e;t.preventDefault();const n=null===(e=t.dataTransfer)||void 0===e?void 0:e.getData("text/plain");if(n)try{const t=JSON.parse(n);t.dataSource!==this.dataSource&&(this.dispatchEvent(new CustomEvent("polygon-moved",{detail:t,bubbles:!0,composed:!0})),this._data.push(t.data),this.render())}catch(t){console.error("Drop event error",t)}})}dispatchData(t){switch(t.type){case"add":this._data.push(t.payload),this.render();break;case"remove":this._data=this._data.filter(e=>e.id!==t.payload.id),this.render()}}get data(){return this._data}set data(t){this._data=t,this.render()}render(){}}const h=document.createElement("template");function l(t,e,n){return Math.min(Math.max(t,e),n)}h.innerHTML=`\n  <style>\n    *, *::before, *::after {\n      margin: 0;\n      padding: 0;\n      box-sizing: border-box;\n      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";\n    }\n    :host {\n      display: block;\n      max-width: 100vw;\n      width: ${n}px;\n      height: ${a}px;\n      overflow: auto;\n      border-radius: 16px;\n      background-color: rgb(243, 244, 246);\n      margin-bottom: 0.5rem;\n    }\n    .container {\n      display: flex;\n      flex-direction: row;\n      flex-wrap: wrap;\n      align-items: flex-start;\n      align-content: flex-start;\n      height: 100%;\n    }\n  </style>\n  <div class="container"></div>\n`,customElements.define("buffer-zone",class extends d{constructor(){super(),this.dataSource="buffer-zone";const t=this.attachShadow({mode:"open"});t.appendChild(h.content.cloneNode(!0)),this._container=t.querySelector(".container"),this.setDragAndDropHandler()}render(){this._container.innerHTML="",this._data.forEach(t=>{const e=document.createElement("polygon-item");e.data=t,e.dataSource=this.dataSource,this._container.appendChild(e)})}});const c=(t,e,n,a,s,i)=>{const o=-s*a,r=-i*a,d=t.width*(1-a)/2,h=t.height*(1-a)/2;return{x:l(e+o,-d,d),y:l(n+r,-h,h)}},g=document.createElement("template");function u(t,e){return Math.floor(Math.random()*(e-t+1))+t}function p(t,e){return Math.random()*(e-t)+t}function m(n=t,a=e,s="#A00",i="#111"){const o=u(a[0],a[1]),r=Math.min(n.width,n.height)/2,d=[];for(let t=0;t<o;t++){const e=2*Math.PI*t/o+p(-Math.PI/o,Math.PI/o),a=p(r/3,r),s=Math.sin(e)*a+n.width/2,i=Math.cos(e)*a+n.height/2;d.push([Math.round(s),Math.round(i)])}return{id:u(1e5,1e6),points:d,fill:s,stroke:i}}g.innerHTML=`\n  <style>\n    :host {\n      display: block;\n      width: fit-content;\n      height: fit-content;\n      border: 1px solid #aaa;\n      background-color: #FFFFFF;\n      overflow: auto;\n    }\n    svg {\n      display: block;\n      background-color: #f0f0f0;\n      cursor: move;\n      width: ${s}px;\n      height: ${i}px;\n    }\n  </style>\n  <div>\n    <svg></svg>\n  </div>\n`,customElements.define("work-zone",class extends d{constructor(){super(),this.scale=1,this.delta={x:0,y:0},this.isDragging=!1,this.lastCoords={x:0,y:0},this.dataSource="work-zone";const t=this.attachShadow({mode:"open"});t.appendChild(g.content.cloneNode(!0)),this._svg=t.querySelector("svg"),this._svg.setAttribute("viewBox",`0 0 ${s} ${i}`),this._svg.addEventListener("wheel",this.handleWheel.bind(this)),this._svg.addEventListener("mousedown",this.handleMouseDown.bind(this)),this._svg.addEventListener("mousemove",this.handleMouseMove.bind(this)),this._svg.addEventListener("mouseup",this.handleMouseUp.bind(this)),this._svg.addEventListener("mouseleave",this.handleMouseUp.bind(this)),this.setDragAndDropHandler()}render(){for(;this._svg.firstChild;)this._svg.removeChild(this._svg.firstChild);const e=Math.floor(s/t.width);this._data.forEach((n,a)=>{const s=a%e*t.width,i=Math.floor(a/e)*t.height,o=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");o.setAttribute("x",String(s)),o.setAttribute("y",String(i)),o.setAttribute("width",String(t.width)),o.setAttribute("height",String(t.height));const r=document.createElement("polygon-item");r.data=n,r.dragstartCallback=this.handleMouseUp.bind(this),r.dataSource=this.dataSource,o.appendChild(r),this._svg.appendChild(o)}),this.updateViewBox()}updateViewBox(){const t=s/2*(1-this.scale)+this.delta.x,e=s*this.scale,n=i/2*(1-this.scale)+this.delta.y,a=i*this.scale;this._svg.setAttribute("viewBox",`${t} ${n} ${e} ${a}`)}handleWheel(t){t.preventDefault();const e=.075*-this.scale*Math.sign(t.deltaY);this.scale=l(this.scale-e,.1,1),this.delta=c(this._svg.getBoundingClientRect(),this.delta.x,this.delta.y,this.scale,0,0),this.updateViewBox()}handleMouseMove(t){if(!this.isDragging)return;const e=t.clientX-this.lastCoords.x,n=t.clientY-this.lastCoords.y;this.delta=c(this._svg.getBoundingClientRect(),this.delta.x,this.delta.y,this.scale,e,n),this.updateViewBox(),this.lastCoords={x:t.clientX,y:t.clientY}}handleMouseDown(t){this.isDragging=!0,this.lastCoords={x:t.clientX,y:t.clientY},this._svg.style.cursor="grabbing"}handleMouseUp(){this.isDragging=!1,this._svg.style.cursor="move"}});const v=()=>{const t=[];for(let e=0;e<u(5,20);e++)t.push(m());return t},w=document.querySelector("buffer-zone"),f=document.querySelector("work-zone");f.addEventListener("polygon-moved",t=>{w.dispatchData({type:"remove",payload:t.detail.data})}),w.addEventListener("polygon-moved",t=>{f.dispatchData({type:"remove",payload:t.detail.data})});const b=()=>{w.data=v(),f.data=[]},y=()=>{const t=JSON.stringify([...w.data,...f.data]);localStorage.setItem("polygons",t),alert("Данные сохранены")},x=()=>{localStorage.removeItem("polygons"),alert("Данные удалены")};window.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("create-btn");t&&t.addEventListener("click",b);const e=document.getElementById("save-btn");e&&e.addEventListener("click",y);const n=document.getElementById("clear-btn");n&&n.addEventListener("click",x)});const _=JSON.parse(localStorage.getItem("polygons"));w.data=null!=_?_:v()})();