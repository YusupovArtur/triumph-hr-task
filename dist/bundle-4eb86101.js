(()=>{"use strict";const t={viewBox:{width:100,height:100},polygonSidesRange:[4,8],fill:"#A00",stroke:"#111",strokeWidth:2,strokeWidthActive:4,paddingShare:.08,padding:0};t.padding=Math.max(t.viewBox.width,t.viewBox.height)*t.paddingShare,t.viewBox.width,t.viewBox.height;const e=50,i="#000",s="#ccc",n=document.createElement("template");n.innerHTML=`\n  <style>\n    :host {\n      display: inline-block;\n      user-select: none;\n      margin: 0;\n      padding: 0;\n      border: 0;\n    }\n    *, *::before, *::after {\n      margin: 0;\n      padding: 0;\n      box-sizing: border-box;\n      border: 0;\n      font: inherit;\n      vertical-align: baseline;\n    }\n    svg {\n      display: block;\n      width: ${t.viewBox.width}px;\n      height: ${t.viewBox.height}px;\n    }\n    .wrap {\n      display: block;\n      width: fit-content;\n      height: fit-content;\n      cursor: grab;\n    }\n  </style>\n  <div class="wrap" draggable="true"></div>\n`;class o extends HTMLElement{constructor(){super(),this._data=null,this.dataSource=null,this.dragstartCallback=void 0;const e=this.attachShadow({mode:"open"});e.appendChild(n.content.cloneNode(!0)),this._wrap=e.querySelector(".wrap"),this._wrap.addEventListener("dragstart",t=>{var e;this.dragstartCallback&&this.dragstartCallback(),this._data&&(null===(e=t.dataTransfer)||void 0===e||e.setData("text/plain",JSON.stringify({data:this._data,dataSource:this.dataSource})),t.dataTransfer.effectAllowed="move")}),this._wrap.addEventListener("mousemove",t=>{t.stopPropagation()}),this._wrap.addEventListener("mousedown",t=>{t.stopPropagation()}),this._wrap.addEventListener("mouseenter",()=>{this._data.strokeWidth!==t.strokeWidthActive&&(this._data.strokeWidth=t.strokeWidthActive,this.render())}),this._wrap.addEventListener("mouseleave",()=>{this._data.strokeWidth!==t.strokeWidth&&(this._data.strokeWidth=t.strokeWidth,this.render())}),this.addEventListener("dragend",()=>{this._data.strokeWidth!==t.strokeWidth&&(this._data.strokeWidth=t.strokeWidth,this.render())})}set data(t){this._data=t,this.dataset.serialized=JSON.stringify(t),this.render()}get data(){return this._data}render(){this._wrap.innerHTML="",this._data&&Array.isArray(this._data.points)&&this._wrap.appendChild((e=>{const i=document.createElementNS("http://www.w3.org/2000/svg","svg"),s=t.padding;return i.setAttribute("viewBox",`${e.sizes.minX-s/2} ${e.sizes.minY-s/2} ${e.sizes.width+s} ${e.sizes.height+s}`),i.appendChild((t=>{const e=document.createElementNS("http://www.w3.org/2000/svg","polygon"),i=t.points.map(t=>`${t.x},${t.y}`).join(" ");return e.setAttribute("points",i),e.setAttribute("fill",t.fill),e.setAttribute("stroke",t.stroke),e.setAttribute("stroke-width",t.strokeWidth.toString()),e})(e)),i.style.width=`${e.sizes.width+s}px`,i.style.height=`${e.sizes.height+s}px`,i})(this._data))}}customElements.define("polygon-item",o);class a extends HTMLElement{constructor(){super(...arguments),this._data=[],this.dataSource=null}setDragAndDropHandler(){this.addEventListener("dragover",t=>{t.preventDefault()}),this.addEventListener("drop",e=>{var i;e.preventDefault();const s=null===(i=e.dataTransfer)||void 0===i?void 0:i.getData("text/plain");if(s)try{const e=JSON.parse(s);e.dataSource!==this.dataSource&&(this.dispatchEvent(new CustomEvent("polygon-moved",{detail:e,bubbles:!0,composed:!0})),this._data.push(Object.assign(Object.assign({},e.data),{strokeWidth:t.strokeWidth})),setTimeout(()=>{this.render()}))}catch(t){console.error("Drop event error",t)}})}dispatchData(t){switch(t.type){case"add":this._data.push(t.payload),this.render();break;case"remove":this._data=this._data.filter(e=>e.id!==t.payload.id),this.render()}}get data(){return this._data}set data(t){this._data=t,this.render()}render(){}}const r=document.createElement("template");function d(t,e,i){return Math.min(Math.max(t,e),i)}r.innerHTML='\n  <style>\n    *, *::before, *::after {\n      margin: 0;\n      padding: 0;\n      box-sizing: border-box;\n      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";\n    }\n    :host {\n      display: block;\n      max-width: 50rem;\n      width: 100%;\n      height: 25dvh;\n      overflow: auto;\n      border-radius: 16px;\n      background-color: rgb(243, 244, 246);\n      margin-bottom: 0.5rem;\n    }\n    .container {\n      display: flex;\n      flex-direction: row;\n      flex-wrap: wrap;\n      align-items: center;\n      align-content: flex-start;\n      height: 100%;\n    }\n  </style>\n  <div class="container"></div>\n',customElements.define("buffer-zone",class extends a{constructor(){super(),this.dataSource="buffer-zone";const t=this.attachShadow({mode:"open"});t.appendChild(r.content.cloneNode(!0)),this._container=t.querySelector(".container"),this.setDragAndDropHandler()}render(){this._container.innerHTML="",this._data.forEach(t=>{const e=document.createElement("polygon-item");e.data=t,e.dataSource=this.dataSource,this._container.appendChild(e)})}});const h=(t,e,i,s,n,o)=>{const a=-n*s,r=-o*s,h=t.width*(1-s)/2,l=t.height*(1-s)/2;return{x:d(e+a,-h,h),y:d(i+r,-l,l)}},l=t=>({x:t.clientX,y:t.clientY}),c=(t,e)=>({x:e.x-t.x,y:e.y-t.y}),u=(t,e)=>t.x*e.x+t.y*e.y,g=(t,e)=>({x:t*e.x,y:t*e.y}),p=document.createElement("template");function w(t,e){return Math.floor(Math.random()*(e-t+1))+t}function v(t,e){return Math.random()*(e-t)+t}function m(e=t.viewBox,i=t.polygonSidesRange,s=t.fill,n=t.stroke){const o=w(i[0],i[1]),a=Math.min(e.width,e.height)/2,r=[];for(let t=0;t<o;t++){const i=2*Math.PI*t/o+v(-Math.PI/o,Math.PI/o),s=v(a/3,a),n=Math.sin(i)*s+e.width/2,d=Math.cos(i)*s+e.height/2;r.push({x:Math.round(n),y:Math.round(d)})}const d=Math.min(...r.map(t=>t.x)),h=Math.max(...r.map(t=>t.x)),l=Math.min(...r.map(t=>t.y)),c=Math.max(...r.map(t=>t.y));return{id:w(1e5,1e6),points:r,fill:s,stroke:n,strokeWidth:t.strokeWidth,sizes:{minX:d,minY:l,width:h-d,height:c-l}}}p.innerHTML="\n  <style>\n    :host {\n      display: block;\n      max-width: 50rem;\n      width: 100%;\n      height: fit-content;\n    }\n    svg {\n      display: block;\n      background-color: #f0f0f0;\n      cursor: move;\n      max-width: 50rem;\n      width: 100%;\n      height: 50dvh;\n    }\n  </style>\n  <div>\n    <svg></svg>\n  </div>\n",customElements.define("work-zone",class extends a{constructor(){super(),this.polygonsCoordinates={},this.scale=1,this.delta={x:0,y:0},this.isDragging=!1,this.lastMouseCoords=null,this.lastTouchCoords=null,this.lastTouchCoords1=null,this.lastTouchCoords2=null,this.dataSource="work-zone";const e=this.attachShadow({mode:"open"});e.appendChild(p.content.cloneNode(!0)),this._svg=e.querySelector("svg");const i=this._svg.getBoundingClientRect();this._svg.setAttribute("viewBox",`0 0 ${i.width} ${i.height}`),this._svg.addEventListener("wheel",this.handleWheel.bind(this)),this._svg.addEventListener("mousedown",this.handleMouseDown.bind(this)),this._svg.addEventListener("mousemove",this.handleMouseMove.bind(this)),this._svg.addEventListener("mouseup",this.handleMouseUp.bind(this)),this._svg.addEventListener("mouseleave",this.handleMouseUp.bind(this)),this._axesGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this._axesGroup.setAttribute("id","axes"),this._svg.appendChild(this._axesGroup),this.updateViewBox(),this.setDragAndDropHandler(),this.addEventListener("drop",e=>{var i;e.preventDefault();const s=null===(i=e.dataTransfer)||void 0===i?void 0:i.getData("text/plain");if(s)try{const i=JSON.parse(s),n=this._svg.getBoundingClientRect();let o=e.clientX-n.left,a=e.clientY-n.top;const r=((t,e,i)=>{const s=i.getBoundingClientRect(),n=i.viewBox.baseVal,o=n.x,a=n.y;return{x:o+t*(n.width/s.width),y:a+e*(n.height/s.height)}})(o,a,this._svg);r.x-=(i.data.sizes.width+t.padding)/2,r.y-=(i.data.sizes.height+t.padding)/2,o=d(r.x,0,n.width-(i.data.sizes.width+t.padding)),a=d(r.y,0,n.height-(i.data.sizes.height+t.padding)),this.polygonsCoordinates[i.data.id]={x:o,y:a},i.dataSource===this.dataSource&&(this.data.sort((t,e)=>t.id===i.data.id?1:e.id===i.data.id?-1:0),this.render())}catch(t){console.error("Drop event error",t)}}),window.addEventListener("resize",this.updateViewBox.bind(this)),this._svg.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!1}),this._svg.addEventListener("touchend",this.handleTouchEnd.bind(this),{passive:!1})}render(){for(;this._svg.firstChild;)this._svg.removeChild(this._svg.firstChild);this._svg.appendChild(this._axesGroup),this._data.forEach(e=>{const i=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");i.setAttribute("x",String(this.polygonsCoordinates[e.id].x)),i.setAttribute("y",String(this.polygonsCoordinates[e.id].y)),i.setAttribute("width",String(e.sizes.width+t.padding)),i.setAttribute("height",String(e.sizes.height+t.padding));const s=document.createElement("polygon-item");s.data=e,s.dragstartCallback=this.handleMouseUp.bind(this),s.dataSource=this.dataSource,i.appendChild(s),this._svg.appendChild(i)})}updateViewBox(){const t=this._svg.getBoundingClientRect(),n=t.width/2*(1-this.scale)+this.delta.x,o=t.height/2*(1-this.scale)+this.delta.y;this._svg.setAttribute("viewBox",`${n} ${o} ${t.width*this.scale} ${t.height*this.scale}`),function(t,n,o){for(;n.firstChild;)n.removeChild(n.firstChild);const a=t.viewBox.baseVal,r=t.getBoundingClientRect(),d=a.x,h=a.y,l=d+a.width,c=h+a.height,u=document.createElementNS("http://www.w3.org/2000/svg","line");u.setAttribute("x1",d.toString()),u.setAttribute("y1",c.toString()),u.setAttribute("x2",l.toString()),u.setAttribute("y2",c.toString()),u.setAttribute("stroke","black"),u.setAttribute("stroke-width",(4*o).toString());const g=document.createElementNS("http://www.w3.org/2000/svg","line");g.setAttribute("x1",d.toString()),g.setAttribute("y1",h.toString()),g.setAttribute("x2",d.toString()),g.setAttribute("y2",c.toString()),g.setAttribute("stroke","black"),g.setAttribute("stroke-width",(4*o).toString());for(let t=Math.ceil(d/e)*e;t<=l;t+=e){const e=document.createElementNS("http://www.w3.org/2000/svg","line");e.setAttribute("x1",t.toString()),e.setAttribute("y1",c.toString()),e.setAttribute("x2",t.toString()),e.setAttribute("y2",(c-12*o).toString()),e.setAttribute("stroke",i),e.setAttribute("stroke-width",(2*o).toString());const a=document.createElementNS("http://www.w3.org/2000/svg","line");a.setAttribute("x1",t.toString()),a.setAttribute("y1",c.toString()),a.setAttribute("x2",t.toString()),a.setAttribute("y2",h.toString()),a.setAttribute("stroke",s),a.setAttribute("stroke-width",(.5*o).toString());const r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("x",t?t.toString():(d+14*o).toString()),r.setAttribute("y",(c-14*o).toString()),r.setAttribute("font-size",(10*o).toString()),r.setAttribute("style","user-select: none;"),r.textContent=t.toString(),n.appendChild(r),n.appendChild(e),n.appendChild(a)}const p=r.height-h,w=r.height-c;for(let t=Math.ceil(w/e)*e;t<=p;t+=e){const e=r.height-t,a=document.createElementNS("http://www.w3.org/2000/svg","line");a.setAttribute("x1",d.toString()),a.setAttribute("y1",e.toString()),a.setAttribute("x2",(d+12*o).toString()),a.setAttribute("y2",e.toString()),a.setAttribute("stroke",i),a.setAttribute("stroke-width",(2*o).toString());const h=document.createElementNS("http://www.w3.org/2000/svg","line");h.setAttribute("x1",d.toString()),h.setAttribute("y1",e.toString()),h.setAttribute("x2",l.toString()),h.setAttribute("y2",e.toString()),h.setAttribute("stroke",s),h.setAttribute("stroke-width",(.5*o).toString());const u=document.createElementNS("http://www.w3.org/2000/svg","text");u.setAttribute("x",(d+14*o).toString()),u.setAttribute("y",t?e.toString():(c-14*o).toString()),u.setAttribute("font-size",(10*o).toString()),u.setAttribute("style","user-select: none;"),u.textContent=t.toString(),n.appendChild(u),n.appendChild(a),n.appendChild(h)}n.appendChild(u),n.appendChild(g)}(this._svg,this._axesGroup,this.scale)}handleWheel(t){t.preventDefault();const e=.075*-this.scale*Math.sign(t.deltaY);this.scale=d(this.scale-e,.3,1),this.delta=h(this._svg.getBoundingClientRect(),this.delta.x,this.delta.y,this.scale,0,0),this.updateViewBox()}handleMouseMove(t){if(!this.isDragging)return;const e=t.clientX-this.lastMouseCoords.x,i=t.clientY-this.lastMouseCoords.y;this.delta=h(this._svg.getBoundingClientRect(),this.delta.x,this.delta.y,this.scale,e,i),this.updateViewBox(),this.lastMouseCoords={x:t.clientX,y:t.clientY}}handleMouseDown(t){this.isDragging=!0,this.lastMouseCoords={x:t.clientX,y:t.clientY},this._svg.style.cursor="grabbing"}handleMouseUp(){this.isDragging=!1,this._svg.style.cursor="move"}handleTouchMove(t){t.preventDefault(),t.stopPropagation();const e=((t,e,i,s,n,o,a)=>{if(e.preventDefault(),e.stopPropagation(),1===e.touches.length&&null!==n){const o=c(n,l(e.touches[0]));return{newDelta:h(t,i.x,i.y,s,o.x,o.y),newScale:s}}if(2===e.touches.length&&null!==o&&null!==a){const n=c(o,l(e.touches[0])),p=c(a,l(e.touches[1])),w=(r=c(l(e.touches[0]),l(e.touches[1])),Math.sqrt(Math.pow(r.x,2)+Math.pow(r.y,2))),v=c(l(e.touches[0]),l(e.touches[1])),m=c(l(e.touches[1]),l(e.touches[0])),b=u(n,v)/w,y=u(p,m)/w,x=g(b/w,n),S=g(y/w,p),f={x:(n.x-x.x)/2+(p.x-S.x)/2,y:(n.y-x.y)/2+(p.y-S.y)/2},A=d(s/((w-b-y)/w),.3,1);return{newDelta:h(t,i.x,i.y,s,f.x,f.y),newScale:A}}var r;return null})(this._svg.getBoundingClientRect(),t,this.delta,this.scale,this.lastTouchCoords,this.lastTouchCoords1,this.lastTouchCoords2);e&&(this.scale=e.newScale,this.delta=e.newDelta,this.updateViewBox()),1===t.touches.length?this.lastTouchCoords=l(t.touches[0]):2===t.touches.length&&(this.lastTouchCoords1=l(t.touches[0]),this.lastTouchCoords2=l(t.touches[1]))}handleTouchEnd(){console.log("end"),this.lastTouchCoords=null,this.lastTouchCoords1=null,this.lastTouchCoords2=null}});const b=()=>{const t=[];for(let e=0;e<w(5,20);e++)t.push(m());return t},y=document.querySelector("buffer-zone"),x=document.querySelector("work-zone");x.addEventListener("polygon-moved",t=>{y.dispatchData({type:"remove",payload:t.detail.data})}),y.addEventListener("polygon-moved",t=>{x.dispatchData({type:"remove",payload:t.detail.data})});const S=()=>{y.data=b(),x.data=[]},f=()=>{const t=JSON.stringify([...y.data,...x.data]);localStorage.setItem("polygons",t),alert("Данные сохранены")},A=()=>{localStorage.removeItem("polygons"),alert("Данные удалены")};window.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("create-btn");t&&t.addEventListener("click",S);const e=document.getElementById("save-btn");e&&e.addEventListener("click",f);const i=document.getElementById("clear-btn");i&&i.addEventListener("click",A)});const _=JSON.parse(localStorage.getItem("polygons"));y.data=null!=_?_:b()})();